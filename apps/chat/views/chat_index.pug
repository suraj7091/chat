extends ../../../views/layout
block styles
  <link rel="stylesheet" href="stylesheet/chat_index.css">
block content
  .card.rare-wind-gradient.chat-room
    .card-body.chat-container
      // Grid row
      .row.px-lg-2.px-2
        // Grid column
        .col-md-6.col-xl-4.px-0
          h6.font-weight-bold.mb-3.text-center.text-lg-left Member
          .white.z-depth-1.px-2.pt-3.pb-0.members-panel-1.scrollbar-light-blue.user-list
            form#userSearchForm 
              input.user-search(type="text",placeholder=" Find User"  required)
              button.search-button(type='submit') search
            hr
            ul.list-unstyled.friend-list#user
              each oldchat in oldchats 
                -let other_user=oldchat.sender!=username?oldchat.sender:oldchat.receiver
                div(id=other_user, class="person"  data-bs-toggle='modal' data-bs-target='#exampleModal')
                  li.p-2
                    a.d-flex.justify-content-between
                      - function get_date(i) {
                      - let d = new Date(i)
                      - let curd=new Date()
                      - if(curd.getMonth()==d.getMonth()&&curd.getDate()==d.getDate()){
                      -  let min_pref= d.getMinutes()>9?"":"0"
                      - return (d.getHours()).toString()+":"+min_pref+(d.getMinutes()).toString()
                      - }else{
                      - return (d.getDate()).toString()+"/"+(d.getMonth()+1).toString()
                      - }
                      - }
                        img.avatar.rounded-circle.d-flex.align-self-center.mr-2.z-depth-1(src='/images/profile.png', alt='avatar')
                      .text-small
                        p.last-chat-div=other_user
                        p.last-message.text-muted.last-chat-div(id=other_user+"old_chat")=oldchat.message.substring(0,30)+' '+get_date(oldchat.created)
                      .chat-footer
                        //- if(allusers[other_user]!=null)
                        //-   svg(height='20', width='20' )
                        //-     circle(cx='10', cy='10', r='10', stroke='', stroke-width='3', fill='green' style='padding-left:0px;')
                        //- else
                        //-   p.text-smaller.text-muted.mb-0(id=other_user+"4")='last login '+get_date(oldchat.created)
                        
                        if(oldchat.offline_count!=0&&oldchat.sender!=username)
                          span.badge.badge-danger.float-right(id=other_user+"3")=oldchat.offline_count
                        else
                          span.badge.badge-danger.float-right(id=other_user+"3" style='display:none')=0

                        span.float-left
                          p(id=other_user+"2" style='color:green' class='chat')


                  hr            
        // Grid column
        // Grid column

        #exampleModal.modal.fade(tabindex='-1' aria-labelledby='exampleModalLabel' aria-hidden='true')
          .modal-dialog
            .modal-content.chat-modal-content
              .modal-header
                h5#exampleModalLabel.modal-title
                button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close') X
              .modal-body#chat-modal
                .chat-message
                  ul.list-unstyled.chat-1.scrollbar-light-blue.chat-modal-list#chat-message                  
                  .none#white(style='display:none')
                    .form-group.basic-textarea
                      form#messageform
                        .sendmsg
                          input#exampleFormControlTextarea2.form-control.pl-2.my-0(type='text', placeholder='Type your message here...' required)
                          button.btn.btn-outline-pink.btn-rounded.btn-sm.waves-effect.waves-dark.float-right.send-msg-btn#send(type='submit') Send         
        .col-md-6.col-xl-8.pl-md-3.px-lg-auto.px-0#chat-mobile-remove
          .chat-message
            ul.list-unstyled.chat-1.scrollbar-light-blue#chat-message                  
            .none#white(style='display:none')
              .form-group.basic-textarea
                form#messageform
                  .sendmsg
                    input#exampleFormControlTextarea2.form-control.pl-2.my-0(type='text', placeholder='Type your message here...' required)
                    button.btn.btn-outline-pink.btn-rounded.btn-sm.waves-effect.waves-dark.float-right.send-msg-btn#send(type='submit') Send 
block scripts
  script(src='https://code.jquery.com/jquery-3.1.1.min.js')
  script(src='js/socket.io.js')
  script(src='js/userSearch.js') 
  script(type='text/javascript').
    if (screen.width > 1000) {
      document.getElementById('exampleModal').remove()
      $('.person').removeAttr('data-bs-toggle')
    } 
    else {
      document.getElementById('chat-mobile-remove').remove()
    }
    let from = '#{username}';
    let to;
    let params = (new URL(document.location)).searchParams;
    let userId = params.get("id");
    //let classname = document.getElementsByClassName("person");
    let myFunction = function () {
      document.getElementById("white").style.display = 'block';
      to = userId?userId:this.getAttribute("id");
      if (screen.width < 1000) {
        document.getElementById("exampleModalLabel").innerHTML = to;
      }
      document.getElementById("chat-message").innerHTML = '';

      document.getElementById(to + "3").style.display = 'none';
      document.getElementById(to + "3").innerHTML = 0;
      let person = document.getElementsByClassName("person");
      for (let j = 0; j < person.length; j++) {
        person[j].style.backgroundColor = 'white';
      }  document.getElementById(to).style.backgroundColor = '#eff2f4';
      $.post('/chat?id=' + to, {}, function (response) {
        let messages = response.messages ||[]
        for (let j = 0; j < messages.length; j++) {
          let date = new Date(Date.parse(messages[j].created));
          let istTime = date.toLocaleString()
          if (messages[j].sender == '#{username}') {
            $("#chat-message").append('  <li class="d-flex justify-content-between mb-3" ><div class="chat-body white p-3 ml-2 z-depth-1" style="max-width:90%"> <div class="header"><strong class="primary-font">' + 'You' + '</strong><small class="pull-right text-muted"><i class="fa fa-clock-o"></i> ' + istTime + '</small></div><hr class="w-100"/> <p class="mb-0">' + messages[j].message + '</p </div> </li>');
          }
          else {
            $("#chat-message").append('<li class="d-flex justify-content-between mb-3"><div></div><div class="chat-body p-3 z-depth-1 " style="background-color:#EEEEEE;margin-right:10px;max-width:90%"><div class="header"><strong class="primary-font">' + 'Other' + '</strong><small class="pull-right text-muted"><i class="fa fa-clock-o"></i> ' + istTime + '</small></div><hr class="w-100"/><p class="mb-0">' + messages[j].message + '</p></div> </li>');
          }
        }
        if (screen.width < 1000) {
          setTimeout(()=>{
             let elem = document.getElementById('chat-message');
            elem.scrollTop = elem.scrollHeight;
            }, 500)
        } else {
          let elem = document.getElementById('chat-message');
          elem.scrollTop = elem.scrollHeight;
        }
      }, 'json');

      userId = null
    };
    if (userId != null) {
      let elem = document.getElementById(userId)
      if(elem){
        elem.remove()
      }
      $('#user').prepend(`
                <div class="person" id=${userId} data-bs-toggle='modal' data-bs-target="#exampleModal" style="background-color: rgb(239, 242, 244)">
                <li class="p-2"><a class="d-flex justify-content-between"><img
                            class="avatar rounded-circle d-flex align-self-center mr-2 z-depth-1" src="/images/profile.png"
                            alt="avatar">
                        <div class="text-small">
                            <p class="last-chat-div">${userId}</p>
                            <p class="last-message text-muted last-chat-div" id="${userId}old_chat"></p>
                        </div>
                        <div class="chat-footer"><span class="badge badge-danger float-right" id="${userId}3"
                                style="display:none">0</span><span class="float-left">
                                <p class="chat" id="${userId}2" style="color:green"></p>
                            </span></div>
                    </a></li>
                <hr>
            </div>
      `)
      myFunction(userId);
    }
    let classname = document.getElementsByClassName("person");
    $("div.person").on("click",myFunction)
  script(src='js/client.js')
  //do not changes the line of above src include 

